# Maintainer: Maxim Reznik <reznikmm@gmail.com>

_realname=matreshka
pkgname=${MINGW_PACKAGE_PREFIX}-${_realname}
pkgrel=1
pkgver=0.8
pkgdesc="set of Ada libraries to develop information systems."
arch=('any')
license=('BSD')
makedepends=("${MINGW_PACKAGE_PREFIX}-gcc-ada"
             "${MINGW_PACKAGE_PREFIX}-gprbuild"
             "${MINGW_PACKAGE_PREFIX}-asis"
            )
depends=("${MINGW_PACKAGE_PREFIX}-gcc-ada"
         )
url="http://forge.ada-ru.org/matreshka"
source=("git+https://github.com/reznikmm/matreshka.git")
sha256sums=('SKIP')

fix_gnat_dll()
{
   # libgnat-6.dll.a and libgnarl-6.dll.a provided by mingw gcc don't work
   # remove them and copy dll-s in place

   libgcc=`gcc -print-libgcc-file-name`
   adalib=`dirname ${libgcc}`/adalib
   if [ -f ${adalib}/libgnat-6.dll.a ]; then
      gcc_bin=`which gcc`
      bin_dir=`dirname ${gcc_bin}`
      echo "Deleting *.dll.a:" rm -f ${adalib}/libgna{t,rl}-6.dll.a
      rm -f ${adalib}/libgna{t,rl}-6.dll.a
      cp ${bin_dir}/libgna{t,rl}-6.dll ${adalib}/
   fi
}

pkgver()
{
   date +%Y.%m.%d
}

prepare()
{
  cd /
  nuget install oracle.instantclient.redist
  export PATH=$PATH:/oracle.instantclient.redist.12.1/build/native/bin/x64
  cd ${srcdir}/${_realname}
  fix_gnat_dll
}

build() {
  cd ${srcdir}/${_realname}
  make config
  ./configure --prefix="${pkgdir}${MINGW_PREFIX}"
  make
}

package() {
  cd ${srcdir}/${_realname}
  make install

  # Copy License Files
  mkdir -p ${pkgdir}${MINGW_PREFIX}/share/licenses/${_realname}
  cp -pf LICENSE ${pkgdir}${MINGW_PREFIX}/share/licenses/${_realname}/
}
